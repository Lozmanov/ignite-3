name: Build Configuration Change Alert

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get list of changed files
        id: changed-files
        run: |
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Check for build config changes
        id: check-config
        run: |
          patterns=(
            "**/build.gradle"
            "**/settings.gradle"
            "**/gradle.properties"
            "gradle/**"
            "**/Dockerfile"
            "**/Dockerfile.*"
            ".github/workflows/**"
          )

          has_match=false
          while IFS= read -r file; do
            for pattern in "${patterns[@]}"; do
              if [[ "$file" == $pattern ]]; then
                echo "Matched build config file: $file"
                has_match=true
                break
              fi
            done
          done < changed_files.txt

          echo "has_build_config_change=$has_match" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: steps.check-config.outputs.has_build_config_change == 'true'
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "Build configuration files were modified in GridGain 9 github repo!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":warning: *Build configuration files were modified in GridGain 9 github repo!* \n\n Commit: <$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA|$GITHUB_SHA> \n Author: <$GITHUB_SERVER_URL/$GITHUB_ACTOR|$GITHUB_ACTOR>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.VD_SLACK_WEBHOOK_URL }}
